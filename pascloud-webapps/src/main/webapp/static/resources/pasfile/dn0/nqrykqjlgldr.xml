<?xml version="1.0" encoding="UTF-8"?>
<pageSetting id="nqrykqjlgldr" title="内勤人员考勤记录管理导入" type="import" version="1.0.0.0" pid="" desc="标准版">
  <template>
    <src>ONLINE</src>
    <column>
      <text>统计月份</text>
      <name>tjrq</name>
      <index>0</index>
      <width>120</width>
      <height />
      <align>center</align>
      <annotate>格式为：yyyyMM
例如：201701</annotate>
      <length>100</length>
      <req>Y</req>
    </column>
    <column>
      <text>行员代号</text>
      <name>hydh</name>
      <index>1</index>
      <width>120</width>
      <height />
      <align>center</align>
      <annotate>填入：行员代号</annotate>
      <length>100</length>
      <req>Y</req>
    </column>
    <column>
      <text>行员名称</text>
      <name>hymc</name>
      <index>2</index>
      <width>120</width>
      <height />
      <align>center</align>
      <annotate />
      <length>100</length>
      <req>Y</req>
    </column>
    <column>
      <text>考勤类型</text>
      <name>kqlx</name>
      <index>3</index>
      <width>120</width>
      <height />
      <align>center</align>
      <annotate>请输入以下考勤内型代表的数字：
1-带薪假：休假，但仍有业务量绩效
2-非带薪假：休假，但没有业务量绩效
3-出差：
4-代岗：</annotate>
      <length>100</length>
      <req>Y</req>
    </column>
    <column>
      <text>考勤天数</text>
      <name>kqts</name>
      <index>4</index>
      <width>120</width>
      <height />
      <align>center</align>
      <annotate />
      <length>100</length>
      <req>Y</req>
    </column>
    <column>
      <text>备注说明</text>
      <name>bzsm</name>
      <index>5</index>
      <width>120</width>
      <height />
      <align>center</align>
      <annotate />
      <length>100</length>
      <req>N</req>
    </column>
  </template>
  <table id="nqrykqjlgldr_table" page="true">
    <col id="ZT" title="状态" align="center" type="string" width="50" />
    <col id="ERROR" title="错误原因" align="center" type="string" width="250" />
    <col id="TJRQ" title="统计月份" align="center" type="" width="120" />
    <col id="HYDH" title="行员代号" align="center" type="" width="120" />
    <col id="HYMC" title="行员名称" align="center" type="" width="120" />
    <col id="KQLX" title="考勤类型" align="center" type="" width="120" />
    <col id="KQTS" title="考勤天数" align="center" type="" width="120" />
    <col id="BZSM" title="备注说明" align="center" type="" width="120" />
  </table>
  <flow>
    <rule>
      <sql type="update">nqrykqjlgldr_check_tjrq_0</sql>
      <sql type="update">nqrykqjlgldr_check_tjrq_1</sql>
      <sql type="update">nqrykqjlgldr_check_hydh_2</sql>
      <sql type="update">nqrykqjlgldr_check_kqlx_3</sql>
      <sql type="update">nqrykqjlgldr_check_kqlx_4</sql>
      <sql type="update">nqrykqjlgldr_check_kqts_5</sql>
      <sql type="update">nqrykqjlgldr_check_kqts_6</sql>
      <sql type="update">nqrykqjlgldr_checkupdate_tjrq_0</sql>
      <sql type="update">nqrykqjlgldr_checkupdate_hymc_0</sql>
      <sql type="update">nqrykqjlgldr_exists_target</sql>
      <sql type="update">nqrykqjlgldr_exists_same_temp</sql>
    </rule>
    <before>
      <sql type="update">nqrykqjlgldr_before_insert_0</sql>
    </before>
    <cover>
      <sql type="delete">nqrykqjlgldr_delete_before_override</sql>
    </cover>
    <insert>
      <sql type="insert">nqrykqjlgldr_insert_into_target</sql>
    </insert>
    <after />
  </flow>
  <sqlMap namespace="studio.nqrykqjlgldr">
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_check_tjrq_0">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t  
		set  t.error=t.error||'统计月份输入错误，格式应该是:yyyyMM!'  
		where  f_java_rule_date(t.tjrq,'yyyyMM')=1  and  t.khdxdh=$login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_check_tjrq_1">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t  set  t.error=t.error||'统计月份输入错误，不能为空!' 
		where  f_java_rule_length(t.tjrq)=0  and  t.khdxdh=$login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_check_hydh_2">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t  set  t.error=t.error||'行员代号不存在!'  
		where  not  exists(select  1  from  khdx_hy  h  where  rtrim(t.hydh)=rtrim(h.hydh))  and  t.khdxdh=$login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_check_kqlx_3">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t  
		set  t.error=t.error||'考勤类型输入错误，只能输入:1位整数,0位小数!'  
		where f_java_rule_length(t.kqlx)&gt;0 and f_java_rule_number(t.kqlx,1,0)=1  and  t.khdxdh=$login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_check_kqlx_4">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t  set  t.error=t.error||'考勤类型输入错误，不能为空!' 
		where  f_java_rule_length(t.kqlx)=0  and  t.khdxdh=$login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_check_kqts_5">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t  
		set  t.error=t.error||'考勤天数输入错误，只能输入:10位整数,2位小数!'  
		where f_java_rule_length(t.kqts)&gt;0 and f_java_rule_number(t.kqts,10,2)=1  and  t.khdxdh=$login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_check_kqts_6">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t  set  t.error=t.error||'考勤天数输入错误，不能为空!' 
		where  f_java_rule_length(t.kqts)=0  and  t.khdxdh=$login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_checkupdate_tjrq_0">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update nqrykqjlgldr_temp t
   set error = error || '由于重算天数的限制，统计月份不能小于最小重跑日期' ||
               (select f_numtochar(f_change_days(cast(s.csz as integer),
                                                 -cast(c.csz as integer))) as maxqsrq
                  from xtb_xtcs s, xtb_xtcs c
                 where s.csmc = 'SYS_DATE'
                   and c.csmc = 'SYS_CSTS')
 where exists (select 1
          from (select f_change_days(cast(s.csz as integer),
                                     -cast(c.csz as integer)) as maxqsrq
                  from xtb_xtcs s, xtb_xtcs c
                 where s.csmc = 'SYS_DATE'
                   and c.csmc = 'SYS_CSTS') mt
         where mt.maxqsrq &gt; (select ym from csb_sjw a where a.tjrq=cast(rtrim(t.tjrq)||'01' as integer)))
   and t.khdxdh = $login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_checkupdate_hymc_0">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update nqrykqjlgldr_temp t set error=error||'行员代号和名称必须一致' where  not exists (    select 1 from khdx_hy hy     where t.hydh=hy.hydh and hy.hymc=t.hymc) and t.khdxdh=$login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_exists_target">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t  set  error=error  ||  '数据已存在!'   where    exists  (         select  1  from  sglr_nqrykqjl  a                  inner  join  khdx_hy  b  on  a.khdxdh=b.khdxdh                where   b.hydh=t.hydh  and  a.kqlx  =t.kqlx  and  substr(a.tjrq,1,6)=t.tjrq   )   and  t.khdxdh=$login_khdxdh$
    </update>
    <update parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_exists_same_temp">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t  set  t.error=error||'存在重复数据!'  where  exists(  select  1  from   (select  tjrq,hydh,kqlx  from  nqrykqjlgldr_temp  dr  where  khdxdh=$login_khdxdh$  group  by  tjrq,hydh,kqlx  having  count(1)<![CDATA[>]]>1  )  dr  where  1=1   and  t.tjrq=dr.tjrq  and  t.hydh=dr.hydh  and  t.kqlx=dr.kqlx)  and  khdxdh=$login_khdxdh$
    </update>
    <insert parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_create_lsb">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      CREATE  TABLE   nqrykqjlgldr_temp   (   tjrq  varchar(100)  ,  hydh  varchar(100)  ,  hymc  varchar(100)  ,  kqlx  varchar(100)  ,  kqts  varchar(100)  ,  bzsm  varchar(100)  ,  khdxdh  integer,error  varchar(1000)   )
    </insert>
    <delete parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_delete_lsb">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      delete from nqrykqjlgldr_temp where khdxdh=$login_khdxdh$
    </delete>
    <insert parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_insert_into_lsb">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      insert  into  NQRYKQJLGLDR_TEMP  (tjrq,hydh,hymc,kqlx,kqts,bzsm,khdxdh,error)  values(?,?,?,?,?,?,?,?)
    </insert>
    <select parameterClass="java.util.Map" id="dn0.nqrykqjlgldr_exists_error_msg" resultClass="java.lang.Integer">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      select  count(1)  from  nqrykqjlgldr_temp  where  length(error) <![CDATA[>]]> 0  and  khdxdh  =  $login_khdxdh$
    </select>
    <select parameterClass="java.util.Map" resultClass="java.lang.Integer" id="dn0.nqrykqjlgldr_exists_same_data">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      select  count(1)  from  nqrykqjlgldr_temp  where  length(error) <![CDATA[>]]> 0  and  error  !=  '数据已存在!'  and  khdxdh  =  $login_khdxdh$
    </select>
    <select parameterClass="java.util.Map" resultClass="java.util.HashMap" id="dn0.nqrykqjlgldr_select_error_msg">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      select  '<![CDATA[<]]>img  src="$path$/lib/themes/common/images/cancel.jpg"  border="0"/<![CDATA[>]]>'  as  zt,  tjrq,hydh,hymc,kqlx,kqts,bzsm,khdxdh,error  from  nqrykqjlgldr_temp  where  khdxdh=$login_khdxdh$  and  length(error)<![CDATA[>]]>0
    </select>
    <select parameterClass="java.util.Map" resultClass="java.lang.Integer" remapResults="true" id="dn0.nqrykqjlgldr_count_all_msg">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      select  count(1)  from  (select  '<![CDATA[<]]>img  src="$path$/lib/themes/common/images/ok.jpg"  border="0"/<![CDATA[>]]>'  as  zt,  tjrq,hydh,hymc,kqlx,kqts,bzsm,khdxdh,error  from  nqrykqjlgldr_temp  where  khdxdh=$login_khdxdh$  )a
    </select>
    <select parameterClass="java.util.Map" resultClass="java.util.HashMap" remapResults="true" id="dn0.nqrykqjlgldr_select_all_msg">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      select  '<![CDATA[<]]>img  src="$path$/lib/themes/common/images/ok.jpg"  border="0"/<![CDATA[>]]>'  as  zt,  tjrq,hydh,hymc,kqlx,kqts,bzsm,khdxdh,error  from  nqrykqjlgldr_temp  where  khdxdh=$login_khdxdh$
    </select>
    <update id="dn0.nqrykqjlgldr_before_insert_0" parameterClass="java.util.Map">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      update  nqrykqjlgldr_temp  t     set  t.tjrq  =  (select  cast(sjw.ym  as  char(100))                     from  csb_sjw  sjw                    where  sjw.TJRQ  =  cast(t.tjrq  ||  '01'  as  INTEGER))
    </update>
    <insert id="dn0.nqrykqjlgldr_insert_into_target" parameterClass="java.util.Map">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      insert  into  sglr_nqrykqjl(tjrq,khdxdh,kqlx,kqts,bzsm,czr,czsj)  select  t.tjrq,a.khdxdh,t.kqlx,t.kqts,t.bzsm,'$login_hydh$',sysdate   from  nqrykqjlgldr_temp  t  inner  join  khdx_hy  a  on  a.hydh=t.hydh  where  t.khdxdh=$login_khdxdh$  and  (F_JAVA_RULE_LENGTH(t.error)=0  or  t.error='数据已存在!')
    </insert>
    <delete id="dn0.nqrykqjlgldr_delete_before_override" parameterClass="java.util.Map">
      <isNotEmpty property="db"><![CDATA[/**!mycat:datanode=$db$**/]]></isNotEmpty>
      delete  from  sglr_nqrykqjl   a  where  exists(      select  1  from  nqrykqjlgldr_temp   t      inner  join  khdx_hy  b  on  t.hydh=b.hydh      where  b.khdxdh=a.khdxdh  and  t.kqlx=a.kqlx  and  t.tjrq=a.tjrq      and  t.khdxdh=$login_khdxdh$  )
    </delete>
  </sqlMap>
</pageSetting>

